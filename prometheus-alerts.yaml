apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kubernetes-ai-alerts
  namespace: monitoring
  labels:
    release: prometheus
spec:
  groups:
  - name: ai-kubernetes-alerts
    rules:
    # ðŸ³ 1. Pod Image Pull Error
    - alert: PodImagePullError
      expr: kube_pod_container_status_waiting_reason{reason=~"ImagePullBackOff|ErrImagePull"} > 0
      for: 1m
      labels:
        severity: warning
        ai_alert: "true"
        pod: "{{ $labels.pod }}"
        instance: "{{ $labels.pod }}"
        namespace: "{{ $labels.namespace }}"
      annotations:
        summary: "Pod image pull error detected"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} failed to pull image. Verify image name, tag, or registry credentials."

    # ðŸ” 2. CrashLoopBackOff
    - alert: CrashLoopBackOff
      expr: kube_pod_container_status_waiting_reason{reason="CrashLoopBackOff"} > 0
      for: 1m
      labels:
        severity: warning
        ai_alert: "true"
        pod: "{{ $labels.pod }}"
        instance: "{{ $labels.pod }}"
        namespace: "{{ $labels.namespace }}"
      annotations:
        summary: "Pod in CrashLoopBackOff state"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting repeatedly. Check logs and resource limits."

    # ðŸ§  3. OOMKilled Containers
    - alert: PodOOMKilled
      expr: kube_pod_container_status_terminated_reason{reason="OOMKilled"} > 0
      for: 1m
      labels:
        severity: warning
        ai_alert: "true"
        pod: "{{ $labels.pod }}"
        instance: "{{ $labels.pod }}"
        namespace: "{{ $labels.namespace }}"
      annotations:
        summary: "Container OOMKilled"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} was OOMKilled. Consider increasing memory limits."

    # ðŸ”¥ 4. High CPU Usage
    - alert: HighCpuUsage
      expr: sum(rate(container_cpu_usage_seconds_total{image!=""}[2m])) by (pod, namespace) > 0.8
      for: 2m
      labels:
        severity: warning
        ai_alert: "true"
        pod: "{{ $labels.pod }}"
        instance: "{{ $labels.pod }}"
        namespace: "{{ $labels.namespace }}"
      annotations:
        summary: "High CPU usage detected"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is using >80% CPU for 2 minutes."

    # ðŸ’¾ 5. High Memory Usage
    - alert: HighMemoryUsage
      expr: sum(container_memory_usage_bytes{image!=""}) by (pod, namespace)
        / sum(kube_pod_container_resource_limits_memory_bytes{image!=""}) by (pod, namespace) > 0.9
      for: 2m
      labels:
        severity: warning
        ai_alert: "true"
        pod: "{{ $labels.pod }}"
        instance: "{{ $labels.pod }}"
        namespace: "{{ $labels.namespace }}"
      annotations:
        summary: "High memory usage detected"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is using >90% of its memory limit."

    # ðŸ’€ 6. Node Down
    - alert: NodeDown
      expr: up{job="node-exporter"} == 0
      for: 1m
      labels:
        severity: critical
        ai_alert: "true"
        node: "{{ $labels.instance }}"
      annotations:
        summary: "Node down"
        description: "Node {{ $labels.instance }} is not responding."

    # ðŸ“¡ 7. Network Unavailable
    - alert: PodNetworkUnavailable
      expr: kube_pod_status_reason{reason="NetworkUnavailable"} > 0
      for: 1m
      labels:
        severity: warning
        ai_alert: "true"
        pod: "{{ $labels.pod }}"
        instance: "{{ $labels.pod }}"
        namespace: "{{ $labels.namespace }}"
      annotations:
        summary: "Pod network unavailable"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has network connectivity issues."

    # ðŸ’½ 8. Disk Pressure
    - alert: NodeDiskPressure
      expr: kube_node_status_condition{condition="DiskPressure", status="true"} == 1
      for: 2m
      labels:
        severity: warning
        ai_alert: "true"
        node: "{{ $labels.node }}"
      annotations:
        summary: "Node disk pressure"
        description: "Node {{ $labels.node }} has DiskPressure=true. Check disk space or I/O bottlenecks."

    # âš ï¸ 9. Pending Pods
    - alert: PodPending
      expr: kube_pod_status_phase{phase="Pending"} > 0
      for: 3m
      labels:
        severity: warning
        ai_alert: "true"
        pod: "{{ $labels.pod }}"
        instance: "{{ $labels.pod }}"
        namespace: "{{ $labels.namespace }}"
      annotations:
        summary: "Pod pending too long"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} pending >3m. Possible scheduling/resource issues."

    # â³ 10. Unschedulable Pods
    - alert: PodUnschedulable
      expr: kube_pod_status_unschedulable > 0
      for: 2m
      labels:
        severity: warning
        ai_alert: "true"
        pod: "{{ $labels.pod }}"
        instance: "{{ $labels.pod }}"
        namespace: "{{ $labels.namespace }}"
      annotations:
        summary: "Pod unschedulable"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} cannot be scheduled due to resource constraints."

