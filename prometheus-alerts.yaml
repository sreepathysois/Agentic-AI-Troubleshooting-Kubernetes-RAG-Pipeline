apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: k8s-alert-rules       # CRD name for Kubernetes management
  namespace: monitoring
  labels:
    release: prometheus
spec:
  groups:
    - name: node.rules         # Logical group for node metrics
      rules:
        - alert: HighNodeCPU
          expr: 100 - (avg by (instance)(rate(node_cpu_seconds_total{mode="idle"}[2m])) * 100) > 80
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: "High CPU usage on node"
            description: "Node {{ $labels.instance }} CPU usage > 80% for 2 minutes."
        - alert: HighMemoryUsage
          expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.85
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High Memory usage"
            description: "Node {{ $labels.instance }} memory usage > 85%."
    - name: pod.rules          # Logical group for pod metrics
      rules:
        - alert: PodCrashLooping
          expr: rate(kube_pod_container_status_restarts_total[5m]) > 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "Pod is crash looping"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting frequently."

        - alert: PodImagePullError
          expr: kube_pod_container_status_waiting_reason{reason=~"ImagePullBackOff|ErrImagePull"} > 0
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: "Pod image pull error {{ $labels.pod }}"
            description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has image pull issues."
